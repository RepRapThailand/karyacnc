<!DOCTYPE html>
<html>
<body>
Copy image from other source and paste here.<br>
<table><tr valign=top><td>
<b>Option</b>
<br>Width <input id=width value=500 size=4>pixel
<br>Dither method <select id=metode>
<option value=0>Grayscale</option>
<option value=1>Floyd steinberg</option>
<option value=2>Sierra 2 row</option>
<option value=3>Clustered</option>
<option value=4>Halftone</option>
</select><br>
<div id=halftoneoption hidden>
<b>Halftone setting</b>
<br>Angle <input id=htangle value=45 size=4>
<br>Spacing <input id=htspacing value=8 size=4>
<br>Wave Amp<input id=htamp value=0 size=4>
<br>Wave Freq<input id=htfreq value=10 size=4>
</div>
<b>Color setting</b>
<br>Gamma correct <input id=gamma value=1 size=4>
<br>Random threshold <input id=rnd value=0 size=4>
<br><button id=redither>Re dither </button>
<hr>
<b>Gcode option</b>
<br>Render width <input id=mwidth value=100 size=3>milimeter
<br>Invert color <input id=invert type=checkbox size=3>
<br>Tools on<input id=tool1 size=10 value="S255"> off <input id=tool1 size=10 value="S0">


<hr>
<img id="thepic" alt="The Pic" >
<td>
<canvas id="myCanvas" width="220" height="277" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<td><B>GCODE</b><hr>
<textarea id=gcode>
</textarea>
</table>

<script>
function getvalue(el){
	return document.getElementById(el).value;
}
function setvalue(el,val){
	document.getElementById(el).value=val;
}
function setevent(ev,bt,act){
	document.getElementById(bt).addEventListener(ev, act,false);
}

function setclick(bt,act){
	setevent("click",bt,act);
}

// Add the paste event listener
window.addEventListener("paste", pasteHandler);

/* Handle paste events */
function pasteHandler(e) {
    // We need to check if event.clipboardData is supported (Chrome)
    if (e.clipboardData) {
        // Get the items from the clipboard
        var items = e.clipboardData.items;
        if (items) {
            // Loop through all items, looking for any kind of image

            for (var i = 0; i < items.length; i++) {

                if (items[i].type.indexOf("image") !== -1) {
                    // We need to represent the image as a file,
                    var blob = items[i].getAsFile();
                    // and use a URL or webkitURL (whichever is available to the browser)
                    // to create a temporary URL to the object
                    var URLObj = window.URL || window.webkitURL;
                    var source = URLObj.createObjectURL(blob);

                    // The URL can then be used as the source of an image
                    createImage(source, blob);
					var img = document.getElementById("thepic");
					img.src=source;
                }
            }
        }
        // If we can't handle clipboard data directly (Firefox),
        // we need to read what was pasted from the contenteditable element
    } else {
        // This is a cheap trick to make sure we read the data
        // AFTER it has been inserted.
        setTimeout(checkInput, 1);
    }
}
function createImage(source, blob) {
    var pastedImage = new Image();
    //clear gcode
    pastedImage.onload = function() {
		ditherit();	
        };
    
    pastedImage.src = source;
}


ditherit = function() {
    var c = document.getElementById("myCanvas");
    var img = document.getElementById("thepic");img.width=getvalue("width")*1;
    c.width=img.width;
    c.height=img.height;
    var ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0,img.width,img.height);
    var bm = ctx.getImageData(0, 0, img.width, img.height);
    // invert colors
    var i,j;
    var row=c.width*4;
	var metode=getvalue("metode")*1;
	var dx,dy;
	var c4x4=[191.25, 95.625, 159.375, 63.75, 15.9375, 255, 223.125, 111.5625, 127.5, 207.1875, 239.0625, 31.875, 47.8125, 143.4375, 79.6875, 175.3125];
	dx=1;
	dy=1;
	if (metode==2){
		dx=2;
		dy=2;
	}
	// make it grayscale first
	var gamma=getvalue("gamma")*1.0;
	for (j = 0; j < c.height; j += 1) {
    for (i = 0; i < c.width; i += 1) {
    	var a=j*row+i*4;
        oldr=(0.2*bm.data[a] + 0.7*bm.data[a+1] +0.1*bm.data[a+2]);
		oldr = Math.pow((oldr / 255.0) , (1.0 / gamma)) * 255;
		bm.data[a]=oldr;
		bm.data[a+1]=oldr;
		bm.data[a+2]=oldr;
	}}
	// dither it
	if (metode<4){
		var rndt=getvalue("rnd");
		var rndt2=rndt/2.0;
		for (j = 0; j < c.height-dy; j += 1) {
		for (i = dx; i < c.width-dx; i += 1) {
			var a=j*row+i*4;
			gr=rndt*Math.random()-(rndt2);
			oldr=bm.data[a];
			if (metode==0){
				newr=oldr+gr;
			} else if (metode<3){
				gr+=128;
				newr=oldr>gr?255:0;
			} else if (metode==3) {
				newr=oldr+gr>=c4x4[(j%4*4+i%4)]?255:0;
			}
			err=oldr-newr;
			bm.data[a+0]=newr;
			bm.data[a+1]=newr;
			bm.data[a+2]=newr;
			if (metode==0){
				// 7 3 5 1 floyd
				a1=a+4; a2=err*7.0/16;bm.data[a1]+=a2;
				a+=row;
				a1=a-4; a2=err*4.0/16;bm.data[a1]+=a2;
				a1=a;   a2=err*4.0/16;bm.data[a1]+=a2;
				a1=a+4; a2=err*1.0/16;bm.data[a1]+=a2;
			}
			else if (metode==1){
				// 7 3 5 1 floyd
				a1=a+4; a2=err*7.0/16;bm.data[a1]+=a2;
				a+=row;
				a1=a-4; a2=err*4.0/16;bm.data[a1]+=a2;
				a1=a;   a2=err*4.0/16;bm.data[a1]+=a2;
				a1=a+4; a2=err*1.0/16;bm.data[a1]+=a2;
			}
			else if (metode==2){
				// sierra 2 row
				a1=a+4; a2=err*5.0/32;bm.data[a1]+=a2;
				a1=a+8; a2=err*3.0/32;bm.data[a1]+=a2;
				a+=row;
				a1=a-8; a2=err*2.0/32;bm.data[a1]+=a2;
				a1=a-4; a2=err*4.0/32;bm.data[a1]+=a2;
				a1=a;   a2=err*5.0/32;bm.data[a1]+=a2;
				a1=a+4; a2=err*4.0/32;bm.data[a1]+=a2;
				a1=a+8; a2=err*2.0/32;bm.data[a1]+=a2;
				a+=row;
				a1=a-4; a2=err*2.0/32;bm.data[a1]+=a2;
				a1=a;   a2=err*3.0/32;bm.data[a1]+=a2;
				a1=a+4; a2=err*2.0/32;bm.data[a1]+=a2;
				
				}
			}
		}
	} else {
	// halftoner
	}
    ctx.putImageData(bm, 0, 0);
	img.width=220;
};

setclick("redither",ditherit);
setevent("change","metode",function(){
document.getElementById("halftoneoption").hidden=getvalue("metode")!=4;
ditherit();
}); 
</script>


</body>
</html>
