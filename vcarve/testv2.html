<body>
<canvas id=mycanv width=800 height=400></canvas>
<textarea id=gcode cols=200 rows=100>
</textarea>
<script>
function $(id) {
    return document.getElementById(id);
}
sqrt=Math.sqrt;
sqr=function(x){return x*x;}
sample=1;
var s1=[100,100, 500,100, 300,150, 500,200, 150,200, 150,250, 100,200, 100,100];
var s2=[120,120, 150,120, 130,150, 120,150, 120,120];
var scale=1;
var move=1;


if (sample) {
// shape = box
	s1=[43.923,-0.046,43.879,-0.018,43.405,1.005,42.635,3.032,42.126,4.528,41.895,5.474,41.929,6.093,42.607,7.565,42.93,8.788,43.579,11.575,44.663,15.335,45.912,19.203,47.067,22.327,48.033,24.784,48.43,26.042,48.3,26.449,47.924,26.928,47.364,27.419,46.666,27.903,45.89,28.339,45.095,28.69,44.329,28.92,43.648,29.004,43.073,28.949,42.448,28.8,41.106,28.25,39.758,27.407,38.523,26.345,37.506,25.194,37.154,24.662,36.881,24.104,36.673,23.483,36.519,22.775,36.312,20.943,35.867,16.365,35.217,12.069,34.338,7.854,33.184,3.521,32.555,1.417,32.493,1.44,30.398,5.267,30.398,5.267,30.053,6.175,30.014,6.556,30.051,6.939,31.204,10.951,31.204,10.951,31.714,13.231,31.943,15.403,32.007,18.124,31.929,21.194,31.796,22.413,31.591,23.503,31.3,24.497,30.915,25.437,30.42,26.383,29.802,27.38,28.917,28.458,27.854,29.329,26.647,29.994,25.375,30.423,24.062,30.614,22.783,30.55,21.583,30.218,21.035,29.955,20.517,29.609,19.502,28.688,18.704,27.613,18.127,26.366,17.758,24.904,17.597,23.208,17.639,21.246,17.876,18.97,18.309,16.371,19.092,12.106,19.456,9.631,19.495,8.907,19.445,8.437,19.314,8.152,19.092,7.995,18.761,7.941,18.303,7.965,17.233,8.206,16.501,8.523,15.909,9.054,15.307,9.992,14.532,11.531,13.599,13.806,12.737,16.676,11.861,20.503,10.876,25.648,10.393,27.834,9.818,29.63,9.151,31.038,8.789,31.598,8.406,32.051,8.004,32.403,7.593,32.649,7.167,32.797,6.721,32.842,6.26,32.788,5.781,32.623,5.289,32.356,4.789,31.981,4.027,31.236,3.373,30.359,2.826,29.328,2.372,28.113,2.006,26.703,1.722,25.066,1.51,23.172,1.239,18.663,1.099,17.42,0.998,17.113,0.84,16.995,0.683,17.044,0.5,17.207,0.208,17.696,0.038,18.582,-0.039,20.094,-0.05,22.462,-0.007,25.083,0.145,26.913,0.485,28.495,1.089,30.395,2.001,32.802,2.918,34.706,2.918,34.706,3.84,36.105,4.307,36.618,4.781,37.011,5.169,37.226,5.169,37.226,5.633,37.391,6.68,37.557,7.741,37.507,8.221,37.395,8.642,37.219,9.279,36.73,9.876,35.968,10.446,34.912,10.991,33.546,11.517,31.844,12.04,29.795,13.762,21.085,14.48,18.123,15.166,15.944,15.475,15.235,15.74,14.826,16.004,14.617,16.175,14.601,16.291,14.737,16.361,15.068,16.294,16.275,15.611,19.785,15.374,21.541,15.232,23.332,15.186,25.099,15.232,26.788,15.374,28.347,15.607,29.719,15.936,30.85,16.306,31.665,16.788,32.488,17.358,33.296,17.992,34.057,18.669,34.748,19.363,35.344,20.048,35.82,20.704,36.141,21.604,36.409,22.514,36.544,23.431,36.555,24.344,36.446,25.243,36.219,26.127,35.882,26.982,35.442,27.805,34.903,28.589,34.272,29.326,33.55,30.007,32.745,30.627,31.863,31.176,30.911,31.647,29.891,32.037,28.807,32.691,26.419,32.859,26.055,32.968,25.951,33.075,26.024,33.255,26.299,34.332,28.876,35.257,30.375,36.377,31.689,37.661,32.801,39.076,33.684,40.58,34.307,42.143,34.65,42.938,34.707,43.732,34.681,45.277,34.415,45.974,34.184,46.618,33.884,47.208,33.517,47.749,33.08,48.24,32.574,48.68,31.995,49.074,31.341,49.422,30.612,49.978,28.934,50.356,26.939,50.564,24.628,50.599,22.172,50.525,21.117,50.376,20.118,50.146,19.13,49.827,18.111,48.345,14.424,47.764,12.719,47.306,11.172,47.13,10.308,47.118232191539335,10.300325530956231,47.13,10.308,47.199,10.293,47.543,10.445,50.891,12.602,50.891,12.602,57.096,16.267,57.096,16.267,61.148,18.856,64.977,21.426,67.652,23.371,71.781,26.855,73.551,28.49386111111111,75.133,30.076,76.535,31.605,77.761,33.092,78.825,34.543,79.726,35.965,80.593,37.564,81.357,39.198,82.016,40.871,82.569,42.568,83.016,44.283,83.358,46.012,83.594,47.745,83.721,49.474,83.742,51.196,83.657,52.904,83.463,54.59,83.165,56.238,82.757,57.854,82.239,59.424,81.611,60.948,79.906,64.253,79.59,65.026,79.603,65.083,79.669,65.082,79.966,64.818,80.509,64.098,82.006,61.799,83.588,59.13,84.658,57.042,85.627,54.465,85.974,53.284,86.243,52.113,86.561,49.667,86.653,46.801,86.6,44.833,86.449,42.94,86.194,41.109,85.83,39.335,85.353,37.614,84.763,35.935,84.049,34.291,83.212,32.679,82.247,31.089,81.148,29.513,79.915,27.948,78.541,26.383,77.026,24.811,75.36,23.229,73.541,21.627,71.572,19.996,69.199,18.227,69.199,18.227,65.758,15.777,65.758,15.777,62.558,13.569,60.902,12.517,59.586,11.834,57.264,10.512,52.632,7.711,50.345,6.082,48.136,4.264,46.301,2.518,45.623,1.762,44.419,0.181,44.131,-0.04,43.923,-0.046];
	s2=[];
	scale=6;
	move=10;
}
var d=5; // 
var maxd=20;
var dstep=0.001;
var dstep2=dstep*20;
// segmentation
var segs=[];
var c = $("mycanv");
var ctx = c.getContext("2d");
ctx.strokeStyle = "#0000ff";
var s=0;
function segmentation(path,rev){
	ctx.beginPath();
	var x1,y1,x2,y2;
	PL=path.length/2;
	for (var p=0;p<PL;p++){
		i=p;
		ii=p+1;
		if (ii>=PL)ii=0;

		if (rev){
			i=PL-i-1;
			ii=PL-ii-1;
		}
		x2=path[i*2+0]*scale+move;
		y2=path[i*2+1]*scale+move;
		if (p>0){

			L=(sqrt(sqr(x2-x1)+sqr(y2-y1)));
			if (L>0){
				ctx.moveTo(x1,y1);
				ctx.lineTo(x2,y2);
				vx=(x2-x1)/L;
				vy=(y2-y1)/L;
				L=Math.floor(L/d)+1;
				dx=(x2-x1)/L;
				dy=(y2-y1)/L;
				
				for (var j=0;j<L;j++){
					px=x1+(j+.5)*dx;
					py=y1+(j+.5)*dy;
					//ctx.beginPath();
					//ctx.moveTo(px,py);
					//ctx.arc(px,py,1,0,2*Math.PI);
					//ctx.stroke();
					segs.push([px,py,s,0,0,0,0,vx,vy,0]); // last 3 is to store data
				}
				s++;
				x1=x2;
				y1=y2;
			}
		} else { 
			x1=x2;
			y1=y2;
			segs.push([x1,y1,-1,x1,y1,0,0,0,0,0]); // last 3 is to store data
		}
	}
	ctx.stroke();
}

if (sample){
segmentation(s1,1);
segmentation(s2,1);
} else {
segmentation(s1,0);
segmentation(s2,1);
}
// create toolpath
// s= number of line
ctx.strokeStyle = "#00ff00";
var n=0;
v=90;
var gc="G0 Z5 F10\nG1 F10\nG64 P0.001\nM3\nT1\n";
ve=Math.tan(v/2*Math.PI/180);
var jj,seg2,seg1,mr2;
for (var i=0;i<segs.length;i++){
	mr2=-1; // d squared
	seg1=segs[i];
	if (seg1[2]==-1){
		// move
		continue;
	}
	if (seg1[6]>0)continue;
	var cx,cy,ox,oy;
	found=0;
	var jj=-1;
	for (var j=0;j<segs.length;j++){
		seg2=segs[j];
		if (seg1[2]==seg2[2])continue; // if on same line dont do it
		seg2[9]=sqr(seg1[0]-seg2[0])+sqr(seg1[1]-seg2[1]);
		
	}
	for (var k=dstep2;k<maxd;k+=dstep2){
		ox=seg1[0]-seg1[8]*k;
		oy=seg1[1]+seg1[7]*k;
		k2=sqr(k);
		k3=sqr(k*3);
		for (var j=0;j<segs.length;j++){
			seg2=segs[j];
			if ((seg1[2]==-1) || (seg1[2]==seg2[2]) ||  (seg2[9]>k3))continue; // if on same line dont do it
			n++;
			// find the distance to the seg2
			// simple way 
			 //r2=sqr(ox-seg2[0])+sqr(oy-seg2[1]);
			// correct way
			///*
			r3=sqr(ox-seg2[0])+sqr(oy-seg2[1]);
			/*if (r2>k3)continue;
			if ((seg2[7]==0) || (seg2[8]==0)) {   // vertical
				r3=r2;
			} else {
				a=seg2[8]/seg2[7];
				c=seg2[1]-seg2[0]*a;
				r3 = sqr(Math.abs(a * ox -  oy + c)) / (a*a+1); 
			}
			//*/
			
			if (r3<k2){
				jj=j;
				mr2=k;
				found=1;
				break;
			}
		}
		if (found)break;
	}
	if (!found){
		cx=ox;
		cy=oy;
		r=maxd;
	} else {
		// recalculate to get more precission
		seg2=segs[jj];
		r=mr2;
		for (var k=mr2;k>mr2-dstep2;k-=dstep){
			cx=seg1[0]-seg1[8]*k;
			cy=seg1[1]+seg1[7]*k;
			k2=sqr(k);
			r3=sqr(ox-seg2[0])+sqr(oy-seg2[1]);
			if (r3>=k2){
				r=k;
				break;
			}
		}	
	}
	cz=-r/ve;
	seg1[3]=cx;
	seg1[4]=cy;
	seg1[5]=cz;
	seg1[6]=r;
	
	if (jj>=0){
		seg2=segs[jj];
		seg2[3]=cx;
		seg2[4]=cy;
		seg2[5]=cz;
		seg2[6]=r;
	}
}
function mround(x) {
    return (parseFloat(x*0.1)).toFixed(2);
}

ctx.beginPath();
for (var i=0;i<segs.length;i++){
	seg1=segs[i];
	cx=seg1[3];
	cy=seg1[4];
	r=seg1[6];
	if (seg1[2]==-1){
		gc+="G0 Z2\n";
		gc+="G0 F6000 X"+mround(seg1[3])+" Y"+mround(-seg1[4])+"\n";
		gc+="G0 Z0\nG1 F1000\n";
		ctx.moveTo(cx,cy);
		continue;
	}
	ctx.lineTo(cx,cy);
	if (r>dstep)gc+="G1 X"+mround(seg1[3])+" Y"+mround(-seg1[4])+" Z"+mround(seg1[5])+" N"+i+"\n";
	ctx.strokeStyle = "#ff0000";
	//r=1;
	//ctx.moveTo(cx+r,cy);
	//ctx.arc(cx,cy,r,0,2*Math.PI);
}
ctx.stroke();
gc+="M2\n";
gcode.value=gc;
console.log(n);
</script>
</body>