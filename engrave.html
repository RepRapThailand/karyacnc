<!DOCTYPE html>
<html>
<style>
.hid2 {display:none}
#editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
</style>
<body style="font-family:arial;font-size:12pt">
<center>Copy image from other source and paste here.<br>
<br></center>
<table width=100% style="margin:auto;border-radius:10px;padding:10px;background:lightgray;border:1px solid"><tr valign=top><td width=300>
<table><tr valign=top><td width=150>
<tr><td colspan=2><b>Image setting</b>
<tr><td>Res X<td><input id=width value=200 size=1 class=saveit>
<tr><td>Res Y<td><input id=height value=200 size=1 class=saveit>
<tr><td>Gamma <td><input id=gamma value=1 size=1 class=saveit>
<tr><td>Invert <td><input id=invert type=checkbox size=3 class=saveit>
<tr><td>Normalize <td><input id=normal type=checkbox size=3 class=saveit>
<tr><td>Flip X <td><input id=flip type=checkbox size=3 class=saveit>
<tr><td>DPI <td><input id=mdpi value=72 size=3 class=saveit>
<tr><td colspan=2><p id=mwidth></p>
<tr><td colspan=2><b>Endmill setting</b>
<tr><td>Bit <td><select id=endmill class=saveit>
<option value=0>V bit</option>
<option value=1 selected>Ballnose</option>
</select><br>
<tr><td>Max Dia <td><input id=dia value=3 size=2 class=saveit>
<tr><td>V Angle <td><input id=vangle value=90 size=2 class=saveit>
<tr><td colspan=2><b>Gcode</b>
<tr><td>Feed <td><input id=speed size=3 value="100" class=saveit>mm/s 
<tr><td>Max Depth <td><input id=zdown value=3 size=3 class=saveit>mm


</table>
<td width=600>
<b>Original Image</b>
<hr>
<img width=200 id="thepic" src="depth1.png" alt="The Pic" >
<br><b>Result</b>
<hr><canvas id="myCanvas" width="160" height="300" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<td>
<b>GCODE</b>
<hr>
<button id=regcode>Generate GCODE </button>
<button id=showgcode>Show GCODE </button>
<br><div id=waktu>Waktu Kerja:</div><B>GCODE</b><button id=btcopy2b>Send to KaryaCNC</button>
<div id=transfer>xx</div>
<div id=gcode class=hid style="font-size:11pt;width:auto;height:500px" >
G0 Z2 F3000
M3
G1 F3000
g0 f350 z0.24G0 F350 Z2

;SHAPE #1
G0 F18000.00 X5.72 Y5.20
G0 F240 Z-1.25
G1 F3000.00 X5.72 Y5.20 Z-1.25
G1 X5.72 Y5.19
G1 X5.72 Y5.20
G1 X5.92 Y5.28
G1 X6.07 Y5.43
G1 X6.15 Y5.62
G1 X6.15 Y5.84
G1 X6.07 Y6.04
G1 X5.92 Y6.20
G1 X5.72 Y6.28
G1 X5.49 Y6.28
G1 X5.30 Y6.20
G1 X5.15 Y6.04
G1 X5.07 Y5.85
G1 X5.07 Y5.62
G1 X5.15 Y5.43
G1 X5.29 Y5.28
G1 X5.49 Y5.20
G1 X5.72 Y5.20
G1 X5.72 Y5.19
G1 X5.72 Y5.20

</div>
</table>

<script src="ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("gcode");
	editor.setReadOnly(true);
    editor.session.setMode("ace/mode/gcode");

	var ws =0;
	var overshot=15;
	function $(id) {
	  return document.getElementById(id);
	}
	function sqr(x){return x*x;}
	function sqrt(x){return Math.sqrt(x);}

	function log(text) {
	  console.log(text);
	}
	function mround(x) {
		return Math.round(x * 1000.0) / 1000.0;
	}

	function getvalue(el){
		return document.getElementById(el).value;
	}
	function setvalue(el,val){
		document.getElementById(el).value=val;
	}
	function setevent(ev,bt,act){
		document.getElementById(bt).addEventListener(ev, act,false);
	}

	function setclick(bt,act){
		setevent("click",bt,act);
	}

	// Add the paste event listener
	window.addEventListener("paste", pasteHandler);

	/* Handle paste events */
	function pasteHandler(e) {
		// We need to check if event.clipboardData is supported (Chrome)
		if (e.clipboardData) {
			// Get the items from the clipboard
			var items = e.clipboardData.items;
			if (items) {
				// Loop through all items, looking for any kind of image

				for (var i = 0; i < items.length; i++) {

					if (items[i].type.indexOf("image") !== -1) {
						// We need to represent the image as a file,
						var blob = items[i].getAsFile();
						// and use a URL or webkitURL (whichever is available to the browser)
						// to create a temporary URL to the object
						var URLObj = window.URL || window.webkitURL;
						var source = URLObj.createObjectURL(blob);

						// The URL can then be used as the source of an image
						createImage(source, blob);
						var img = document.getElementById("thepic");
						img.src=source;
					}
				}
			}
			// If we can't handle clipboard data directly (Firefox),
			// we need to read what was pasted from the contenteditable element
		} else {
			// This is a cheap trick to make sure we read the data
			// AFTER it has been inserted.
			setTimeout(checkInput, 1);
		}
	}
	function createImage(source, blob) {
		var pastedImage = new Image();
		//clear gcode
		pastedImage.onload = function() {
			prepareimage();
			//generategcode();		
			};
		
		pastedImage.src = source;
	}

	var sierra2=[6,2 ,1,4,7,4,1 ,1,5,1];

	sierra2=[5, 3, 2, 4, 5, 4, 2, 2, 3, 2];

	var floyd1=[7, 4,4,1];
	var memlimit=8000;

	var bmd=[];
	var bmdz=[];
	var bmw=0;
	var bmh=0;
	var mw=0;
	var mh=0;
	var maxi=0;
	var mini=0;
	var gcodes=[];
	function generategcode(){
		prepareimage();
		var c = document.getElementById("myCanvas");
		var ctx = c.getContext("2d");
		var scale = 25.4 / getvalue('mdpi');
		var zdown=getvalue("zdown");
		var feed=getvalue("speed")*60;
		var endmill=getvalue("endmill")*1;
		var waktu=0;
		var w0=0;
		var w1=0;
		var row=bmw;
		var stepx=mw/bmw;
		var stepy=mh/bmh;
		var r=getvalue("dia")*0.5;
		var r2=sqr(r);
		var rx=r/stepx;
		var ry=r/stepy;
		var rd=[];
		var ri=0;
		var ve=1.0/Math.tan(getvalue("vangle")*Math.PI/360);
		var rv=ve*r;
		// generate tool shape for ballnose
		
		for (var ji=-Math.ceil(ry);ji<=ry;ji++){
			for (var ii=-Math.ceil(rx);ii<=rx;ii++){
				// v bit
				if (endmill==0){
					lr=sqr(ii*stepx)+sqr(ji*stepy);
					c2=sqrt(lr)*ve; //  0  1         2  3  4          5 
					if (c2>=0)rd.push([ji*row+ii,c2,ii,ji]);
				}			
				// ballnose
				if (endmill==1){
					lr=sqr(ii*stepx)+sqr(ji*stepy);
					c2=r2-(lr); //  0  1         2  3  4          5 
					if (c2>=0)rd.push([ji*row+ii,r-sqrt(c2),ii,ji]);
				}			
			}
		}
		var bm = ctx.getImageData(0, 0, c.width, c.height);
		zscale=getvalue("zdown")/255.0;
		gcodes=[];
		var zp=0;
		var xp=Math.floor(rx)*stepx;
		var yp=Math.floor(ry)*stepy;
		gcodes.push("M3\nG0 F2000 Z2\nG0 X"+mround(xp)+" Y"+mround(yp)+"\nG1 F"+feed+" Z0");
		var n=0;
		var lx,ly,lz;
		lz=0;
		var totalz=0;
		var total=mw*mh/stepy;
		rx=0;
		ry=0;
		for (var j = Math.floor(ry); j < Math.floor(bmh-ry); j += 1) {
			n=!n;
			var i;
			mrx=Math.floor(rx);
			for (var ni = mrx; ni < bmw-mrx; ni += 1) {
				// alternate direction left right left right
				if (n) i=ni; else i=bmw-ni;
				// lets check surrounding area
				var cp=j*row+i;
				var zm=1000;
				for (var k=0;k<rd.length;k++){
					var rdk=rd[k];
					if ((j+rdk[3]<0) || (j+rdk[3]>=bmh) || 
						(i+rdk[2]<0) || (i+rdk[2]>=bmw) )continue;	
					zp=(255-bmd[cp+rdk[0]])*zscale+rdk[1];
					if (zp<zm)zm=zp;
					
				}
				bmdz[cp]=zm;
				totalz+=Math.abs(lz-zm);	
				xp=i*stepx;
				yp=j*stepy;
				gcodes.push("G1 X"+mround(xp)+" Y"+mround(yp)+" Z-"+mround(zm));
				lz=zm;
			}
		}
		for (var j = 0; j < bmh; j += 1) {
		for (var i = 0; i < bmw; i += 1) {
			var a=j*bmw+i;		
			oldr=bmdz[a]/zscale;
			a=j*row*4+i*4;
			bm.data[a]=oldr;
			bm.data[a+1]=oldr;
			bm.data[a+2]=oldr;
			bm.data[a+3]=255;
		}}
		// generate gcode
		

		ctx.putImageData(bm, 0, 0);
		gcodes.push("G0 Z3\nG0 X0 Y0\nG0 Z0\nM3 S0\nM5");
		t=(total+totalz)/(feed/60);
		harga=t/60*1500;
		document.getElementById("waktu").innerHTML="<b>TOTAL BIAYA:Rp "+mround(harga)+"</b><br>Waktu:"+mround(t/60)+"menit";
		//img.width=220;
		savesetting();
	}


	function prepareimage() {
		var c = document.getElementById("myCanvas");
		var img = document.getElementById("thepic");
		var scale = 25.4 / getvalue('mdpi');
		rwidth=scale*img.naturalWidth;
		rheight=scale*img.naturalHeight;
		img.width=getvalue("width")*1;
		
		c.width=img.width;
		c.height=getvalue("height");
		var ctx = c.getContext("2d");
		var flip=$("flip").checked;
		var stepx=mw/bmw;
		var stepy=mh/bmh;
		var d=0;//getvalue("dia")*0.75;
		var dx=d/stepx;
		var dy=d/stepy;
		
		ctx.fillStyle="#000000";
		ctx.fillRect(0, 0, c.width, c.height);
		ctx.drawImage(img, dx, dy,c.width-2*dx,c.height-2*dy);
		var bm = ctx.getImageData(0, 0, c.width, c.height);
		// invert colors
		bmw=c.width;
		bmh=c.height;
		var i,j;
		var row=bmw*4;
		// make it grayscale first
		var inv=document.getElementById("invert").checked;
		var gamma=getvalue("gamma")*1.0;
		mw=rwidth*1.0;
		mh=rheight*1.0;
		$("mwidth").innerHTML="Size: "+mround(mw)+" x "+mround(mh)+"mm <br>Step mm X:"+mround(stepx)+ " Y:"+mround(stepy);
		//var mh=mw*c.height/c.width;
		var dotscale=mw/bmw;
		
		var ystep=mh/bmh; // y machine step, each step will be lasered by ystep/0.2 zigzag,  
		bmd=[];
		for (var j = 0; j < bmh; j += 1) {
			for (var i = 0; i < bmw; i += 1) {
				var a=j*row;
				if (flip)a+=(row-i*4); else a+=i*4;
				oldr=(0.3*bm.data[a] + 0.5*bm.data[a+1] +0.2*bm.data[a+2]);
				if (inv)oldr=255-oldr;
				oldr = Math.pow((oldr / 255.0) , (1.0 / gamma)) * 255;
				alp=(bm.data[a+3])/255;
				oldr=(oldr*(alp))+(255*(1-alp));

				var a=j*bmw+i;
				//oldr=255-oldr;
				maxi=Math.max(maxi,oldr);
				mini=Math.min(mini,oldr);
				bmd[a]=oldr;
				bmdz[a]=oldr;
			}
		}
		var sc=255/(maxi-mini);
		if (!$("normal").checked){
			sc=1;
			mini=0;
		}
		for (var j = 0; j < bmh; j += 1) {
			for (var i = 0; i < bmw; i += 1) {
				var a=j*bmw+i;		
				oldr=(bmd[a]-mini)*sc;
				bmd[a]=oldr;
				a=j*row+i*4;
				bm.data[a]=oldr;
				bm.data[a+1]=oldr;
				bm.data[a+2]=oldr;
				bm.data[a+3]=255;
			}
		}
		// dither it

		ctx.putImageData(bm, 0, 0);
		img.width=220;
	};
	function copy_to_server(id) {
	//	var address = window.location.href.replace('http', 'ws');
	//	var ws= new WebSocket(address);
	//	ws.addEventListener('open', function() {
		var address = window.location.href.replace('http', 'ws');
		ws= new WebSocket(address);
		var lines=gcodes;//document.getElementById(id).value.split("\n");
		var x=0;
		ws.addEventListener('message', function(e) {
			if (e.data=="OK") {
				$("transfer").innerHTML="Transfer OK";
				setTimeout(function(){
						ws.close();
						$("transfer").innerHTML="";
						$("btcopy2b").style.display="inline-block";
						//confirm("Upload success");
				},2000);
			}
			if (e.data=="DATA"){
				for (var ix=0;ix<100;ix++){
					if (x>=lines.length){
						ws.send(">FINISH");
						return;
					}
					ws.send(lines[x]+"\n");
					x++;
				}
				//ws.send(document.getElementById(id).value);
				ws.send(">PAUSE");
			}
		});
		ws.addEventListener('open', function() {
			$("btcopy2b").style.display="none";
		});
		ws.addEventListener('close', function() {
			$("btcopy2b").style.display="inline-block";
		});
		
	//	});
	}


	setclick("btcopy2b",function(){copy_to_server('gcode');});
	setclick("regcode",generategcode);
	setclick("showgcode",function(){	editor.setValue(gcodes.join("\n"),-1);});

	var stotype=0;
	try {
	storage=chrome.storage.local;

	} catch(e){
	stotype=1;
	storage=localStorage;
	}

	function savesetting(){
	   a=document.getElementsByClassName("saveit");
	   sett={};
	   for (var i=0;i<a.length;i++){
			if (a[i].type=='text')sett[a[i].id] = a[i].value;
			if (a[i].type=='select-one')sett[a[i].id] = a[i].value;
			if (a[i].type=='checkbox')sett[a[i].id] = a[i].checked;
	   }
	   //text1=document.getElementById("gcode").innerHTML;
	   if (stotype==1){
		 storage.setItem("settings",JSON.stringify(sett));
		 //storage.setItem("text1",text1);
	   } else {
		 //storage.set({"settings":sett,"text1":text1});
	   }
	}
	//setclick("btsaveset",savesetting);


	if (stotype==0){
		try {
		   //storage.get("text1",function(r){document.getElementById("gcode").innerHTML=r.text1;})
		   storage.get("settings",function(r){
			  sett=r.settings;
			  for (var k in sett){
					var a=$(k);
					if (a.type=='checkbox')a.checked=sett[k];else setvalue(k, sett[k]);
			  }
		   });
		} catch (e) {
		}
	} else {
	   //text1=storage.text1;
	   //if (text1==undefined)text1="";
	   if (storage.settings!=undefined){
		   sett=JSON.parse(storage.settings);
		   for (var k in sett){
				setvalue(k,sett[k]);
		   }
	   }
	   //document.getElementById("gcode").innerHTML=text1;
	}	

	// websocket
	document.addEventListener('DOMContentLoaded', function() {
	// FIXME: Wait for 1s so that HTTP Server socket is listening...
	  var address = window.location.href.replace('http', 'ws');
	  /*ws= new WebSocket(address);
	  ws.addEventListener('open', function() {
		log('Connected');
	  });
	  ws.addEventListener('close', function() {
		log('Connection lost');
	  });
	  ws.addEventListener('message', function(e) {
		log(e.data);
	  });
	  */
	});
</script>


</body>
</html>
